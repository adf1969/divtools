{#
Template: auto-presence.yaml
Generated by: gen_presence_sensors.py
Last Updated: 11/25/2025 2:00:00 PM CDT

Available Context Variables:

  timestamp (string)
    - Format: YYYY-MM-DD HH:MM:SS
    - Example: "2025-11-25 14:30:00"
    - Usage: {{ timestamp }}

  areas (list of dict)
    - List of area dictionaries with minimal data (template logic is here)
    - Each area dict contains:
      * area_name (string): Friendly display name
        Example: "Living Room"
      * area_id (string): Home Assistant area ID
        Example: "living_room"
      * area_slug (string): Slugified area name (lowercase, underscores)
        Example: "living_room"

#}
###############################################################################
#   @author         :   Andrew Fields
#   @date           :   {{ timestamp }} Generated
#   @hostname       :   {{ gen_hostname }} Generated this file
#   @package        :   Auto Presence
#   @description    :   A Collection of Occupancy Sensors for Every Area
###############################################################################
#
# WARNING: This file is auto-generated by gen_presence_sensors.py
# Do not edit manually - changes will be overwritten!
# This file is created by running: 
#  $DIVTOOLS/scripts/hass/gen_presence_sensors.py
#  or
#  pvrun -v hass -p scripts/hass -s gen_presence_sensors.py
#  > See pvrun.sh for usage. pvrun is an alias.

template:
  - binary_sensor:
{%- for area in areas %}
      - name: {{ area.area_name }} Occupied
        unique_id: {{ area.area_id }}_occupied
        icon: >
          {% raw %}
          {%- if this.state == 'on' -%}
            {%- if this.attributes.people_count >= 2 -%}
          mdi:account-multiple-check
            {%- else -%}
          mdi:account-check
            {%- endif -%}
          {%- else -%}
          mdi:account-outline
          {%- endif -%}
          {% endraw %}

        device_class: occupancy
        state: >
          {{'{{'}} (expand('group.room_presence')
          | selectattr('state', 'eq', '{{ area.area_name }}')
          | list
          | count >= 1 )
          or
          (states.binary_sensor |
              selectattr('entity_id', 'in', area_entities('{{ area.area_id }}')) |
              rejectattr('attributes.device_class', 'undefined') |
              selectattr('attributes.device_class', 'search', '(occupancy|motion|door|running)') |
              selectattr('state', 'eq', 'on') |
              map(attribute='entity_id') |
              list | count > 0 )
          {{'}}'}}
        attributes:
          area_name: {{ area.area_name }}
          people_count: >
            {{'{{'}} expand('group.room_presence')
            | selectattr('state', 'eq', '{{ area.area_name }}')
            | list
            | count {{'}}'}}
          people: >
            {{'{{'}} (expand('group.room_presence')
            | selectattr('state', 'eq', '{{ area.area_name }}')
            | map(attribute='entity_id')
            | map('replace', 'sensor.', '')
            | map('replace', '_room', '')
            | list
            | join(', ') )
            {{'}}'}}
          area_id: {{ area.area_id }}
          area_slug: {{ area.area_slug }}
{%- endfor %}

