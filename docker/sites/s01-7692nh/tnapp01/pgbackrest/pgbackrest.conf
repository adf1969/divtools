# pgBackRest Configuration
# Last Updated: 12/30/2025 12:00:00 AM CDT
# Backs up PostgreSQL server running in Docker container at tnapp01
# Data is bind-mounted at /opt/postgres on the host

[global]
# Base directory for logs and backups
repo1-path=/opt/pgbackrest

# Compress backups
compress-type=gz
compress-level=9

# ============================================================================
# RETENTION POLICY
# ============================================================================
# IMPORTANT: All retention settings MUST be prefixed with repo1- (or repo2-, repo3-, etc.
# for multiple repositories). Without the repo prefix, the settings will be ignored.
#
# Repo Prefix System:
#   - repo1-retention-full    : First repository retention policy
#   - repo2-retention-full    : Second repository (if configured for S3, Azure, etc.)
#   - repo3-retention-full    : Third repository, and so on...
#
# This allows pgBackRest to manage multiple backup repositories with different
# retention policies (e.g., local repo1 keeps 7 days, cloud repo2 keeps 30 days).
#
# Retention strategy example: Keep 30 days of backups with:
#   - Full backup once per week (Sunday)
#   - Incremental backups daily (Monday-Saturday)
#
# Differential vs Incremental Backups:
#   DIFFERENTIAL: Backs up ALL changes since the last FULL backup
#     - Larger than incremental but smaller than full
#     - Only needs full backup + differential for restore
#     - Better for: Databases with moderate change rates
#     - Example: Full (100MB) + Diff (20MB) = 120MB to restore
#
#   INCREMENTAL: Backs up ONLY changes since the LAST backup (any type)
#     - Smallest backup size, most space efficient
#     - Needs full backup + all incrementals back to last differential
#     - Better for: Databases with high change rates or limited storage
#     - Example: Full (100MB) + Incr1 (5MB) + Incr2 (3MB) + Incr3 (2MB) = 110MB to restore
#
# For 30-day retention with daily backups:
#   RECOMMENDED STRATEGY: Full 1x/week + Incremental daily (most space efficient)
#     - Backup sequence: Full Sun + Incr Mon-Sat, repeat each week
#     - Storage: ~110-140MB/week (vs 550MB+ with all differentials)
#     - Restore time: Slightly longer (replaying multiple incremental backups)
#
# Configuration options (ALL must have repo1- prefix):
#   repo1-retention-full=4           # Keep last 4 full backups
#   repo1-retention-full-type=count  # Retention by count (not days)
#   repo1-retention-full-age=30d     # Or keep for 30 days
#   repo1-retention-diff=6           # Keep diff backups between fulls
#   repo1-retention-incr=6           # Keep incremental backups

# Current configuration: Keep last 7 full backups (approximately 7 weeks)
# repo1-retention-full=7
# repo1-retention-full-type=count

# Example for 30-day retention (uncomment to use):
# repo1-retention-full=4                # 4 full backups (1 per week)
# repo1-retention-full-type=count
# repo1-retention-full-age=30d          # Or use age-based: 30 days

# ACTIVE 30-DAY RETENTION CONFIGURATION
# Keeps 4 full backups (1 per week = ~4 weeks) + incremental backups for 30 days
# Strategy: Full backup weekly + Incremental daily (most space efficient)
repo1-retention-full=4
repo1-retention-full-type=count
repo1-retention-diff=6

# WAL retention - keep WAL files needed for incremental backups
# MUST include repo1- prefix
repo1-retention-archive-type=diff

# Logging configuration
log-level-console=info
log-level-file=debug
log-path=/var/log/pgbackrest

# ============================================================================
# PARALLEL WORKERS
# ============================================================================
# Parallel workers speed up backup and restore operations by using multiple
# processes. More workers = faster backups but higher CPU/IO usage.
#
# Configuration options:
#   process-max=<num>            # Max processes for backup/restore (default: 1)
#
# Recommendations:
#   1-2 workers:  Small databases (<10GB) or low-resource hosts
#   4-8 workers:  Medium databases (10-100GB) on modern hardware
#   8+ workers:   Large databases (>100GB) on high-performance systems
#
# Notes:
#   - Backup size has minimal impact on worker count
#   - More workers increases compression CPU usage
#   - Restore is typically single-threaded regardless of worker count
#   - I/O throughput is the limiting factor, not CPU
#
# Recommended starting point: Match number of CPU cores or half of them
# Example for 8-core system: process-max=4

# Uncomment to enable parallel workers (example: 4 workers)
process-max=2

# The following defines the Database backup Stanza
[postgres]
# Local database backup configuration
# PostgreSQL data is bind-mounted from Docker container to /opt/postgres
pg1-path=/opt/postgres/pgdata

# Manifest save configuration
manifest-save-threshold=1073741824
