# Samba Configuration Guide - Active Directory Services

**Last Updated:** December 4, 2025

## Overview

This guide provides detailed information on configuring Samba as an Active Directory Domain Controller, including best practices, common configurations, and troubleshooting tips.

## Understanding Samba AD DC

Samba 4.x provides a fully functional Active Directory Domain Controller implementation that is compatible with Windows Server Active Directory. It includes:

- **LDAP Directory Service:** RFC 2307 compliant directory
- **Kerberos KDC:** Authentication service
- **SMB/CIFS File Sharing:** Windows-compatible file and printer sharing
- **DNS Server:** Internal DNS or BIND9 DLZ backend support
- **Group Policy:** SYSVOL and GPO support for Windows clients

## Core Configuration Files

### /etc/samba/smb.conf

The main Samba configuration file, automatically generated during domain provisioning:

```ini
# Samba AD DC Configuration
# Auto-generated by samba-tool domain provision

[global]
    # Network settings
    netbios name = ADS1-98
    realm = AVCTN.LAN
    workgroup = AVCTN
    dns forwarder = 10.1.1.111
    server role = active directory domain controller
    idmap_ldb:use rfc2307 = yes
    
    # Security settings
    server signing = auto
    client signing = auto
    server min protocol = SMB2_10
    client min protocol = SMB2
    
    # Logging
    log level = 1
    log file = /var/log/samba/log.%m
    max log size = 10000
    
    # Performance tuning
    socket options = TCP_NODELAY IPTOS_LOWDELAY
    read raw = yes
    write raw = yes
    
    # Disable printing (optional)
    load printers = no
    printing = bsd
    printcap name = /dev/null
    disable spoolss = yes

[netlogon]
    path = /var/lib/samba/sysvol/avctn.lan/scripts
    read only = No

[sysvol]
    path = /var/lib/samba/sysvol
    read only = No
```

### /etc/krb5.conf

Kerberos configuration (copied from `/var/lib/samba/private/krb5.conf`):

```ini
[libdefaults]
    default_realm = AVCTN.LAN
    dns_lookup_realm = false
    dns_lookup_kdc = true
    ticket_lifetime = 24h
    renew_lifetime = 7d
    forwardable = yes
    rdns = false
    default_ccache_name = KEYRING:persistent:%{uid}

[realms]
    AVCTN.LAN = {
        kdc = ads1-98.avctn.lan
        kdc = ads2-99.avctn.lan
        admin_server = ads1-98.avctn.lan
        default_domain = avctn.lan
    }

[domain_realm]
    .avctn.lan = AVCTN.LAN
    avctn.lan = AVCTN.LAN
```

## Common Configuration Tasks

### Adjusting Log Levels

```bash
# View current log level
samba-tool testparm | grep "log level"

# Set higher verbosity for troubleshooting
samba-tool testparm --section-name=global --parameter-name="log level" --option="log level = 3"

# Common log levels:
# 0 = Only critical messages
# 1 = Important messages (default)
# 2 = Warnings and notices
# 3 = Informational messages
# 5 = Debug authentication
# 10 = Full debug (very verbose)
```

### Managing DNS Zones

```bash
# List DNS zones
samba-tool dns zonelist localhost -U Administrator

# Create new zone
samba-tool dns zonecreate localhost example.com -U Administrator

# Add A record
samba-tool dns add localhost avctn.lan testhost A 10.1.1.100 -U Administrator

# Add CNAME record
samba-tool dns add localhost avctn.lan www CNAME testhost -U Administrator

# Delete record
samba-tool dns delete localhost avctn.lan testhost A 10.1.1.100 -U Administrator

# Query DNS
samba-tool dns query localhost avctn.lan testhost A -U Administrator
```

### User Management

```bash
# Create user
samba-tool user create jdoe 'SecurePassword123!' \
    --given-name=John \
    --surname=Doe \
    --mail-address=jdoe@avctn.lan \
    --login-shell=/bin/bash \
    --home-directory=/home/jdoe

# Disable user account
samba-tool user disable jdoe

# Enable user account
samba-tool user enable jdoe

# Reset password
samba-tool user setpassword jdoe --newpassword='NewPassword123!'

# Set password to never expire
samba-tool user setexpiry jdoe --noexpiry

# Delete user
samba-tool user delete jdoe

# List all users
samba-tool user list

# Show user details
samba-tool user show jdoe
```

### Group Management

```bash
# Create group
samba-tool group add 'IT Staff' --description='IT Department Staff'

# Add user to group
samba-tool group addmembers 'IT Staff' jdoe

# Remove user from group
samba-tool group removemembers 'IT Staff' jdoe

# List group members
samba-tool group listmembers 'IT Staff'

# List all groups
samba-tool group list

# Delete group
samba-tool group delete 'IT Staff'
```

### Organizational Unit (OU) Management

```bash
# Create OU
samba-tool ou create 'OU=Servers,DC=avctn,DC=lan'
samba-tool ou create 'OU=Workstations,DC=avctn,DC=lan'
samba-tool ou create 'OU=IT,OU=Users,DC=avctn,DC=lan'

# List OUs
samba-tool ou list

# Delete OU (must be empty)
samba-tool ou delete 'OU=IT,OU=Users,DC=avctn,DC=lan'

# Move user to OU
samba-tool user move 'CN=jdoe,CN=Users,DC=avctn,DC=lan' \
    'OU=IT,OU=Users,DC=avctn,DC=lan'
```

## FSMO Roles Management

### Understanding FSMO Roles

**Forest-wide roles (one per forest):**

- **Schema Master:** Controls schema modifications
- **Domain Naming Master:** Controls addition/removal of domains in forest

**Domain-wide roles (one per domain):**

- **RID Master:** Allocates RID pools to DCs for object creation
- **PDC Emulator:** Synchronizes time, handles password changes, acts as primary DC
- **Infrastructure Master:** Updates cross-domain group memberships

### FSMO Commands

```bash
# Show all FSMO roles
samba-tool fsmo show

# Transfer FSMO role to another DC
samba-tool fsmo transfer --role=pdc -U Administrator
samba-tool fsmo transfer --role=rid -U Administrator
samba-tool fsmo transfer --role=infrastructure -U Administrator
samba-tool fsmo transfer --role=schema -U Administrator
samba-tool fsmo transfer --role=naming -U Administrator

# Seize FSMO role (if original DC failed)
samba-tool fsmo seize --role=pdc -U Administrator
```

**Best Practices:**

- Keep all FSMO roles on primary DC for small deployments
- Separate Schema Master for production forests
- PDC Emulator should have reliable NTP source
- Never seize roles unless absolutely necessary (can cause corruption)

## Replication Management

### Viewing Replication Status

```bash
# Show replication partners
samba-tool drs showrepl

# Show detailed replication info
samba-tool drs showrepl --verbose

# Check replication health
samba-tool drs replicate ads2-99 ads1-98 DC=avctn,DC=lan --full-sync

# Show replication metadata for object
samba-tool drs showrepl ads1-98.avctn.lan -U Administrator
```

### Force Replication

```bash
# Replicate from specific DC
samba-tool drs replicate TARGET_DC SOURCE_DC DC=avctn,DC=lan

# Example: Replicate from ads1-98 to ads2-99
samba-tool drs replicate ads2-99.avctn.lan ads1-98.avctn.lan DC=avctn,DC=lan
```

### Replication Troubleshooting

```bash
# Check replication errors
samba-tool drs showrepl | grep -i error

# View DRS (Directory Replication Service) options
samba-tool drs options ads1-98.avctn.lan

# Bind to specific DC and verify
samba-tool drs bind ads1-98.avctn.lan -U Administrator
```

## Security Configuration

### Password Policies

```bash
# View password policy
samba-tool domain passwordsettings show

# Set minimum password length
samba-tool domain passwordsettings set --min-pwd-length=12

# Set password complexity requirement
samba-tool domain passwordsettings set --complexity=on

# Set password history (prevent reuse)
samba-tool domain passwordsettings set --history-length=24

# Set minimum password age (days)
samba-tool domain passwordsettings set --min-pwd-age=1

# Set maximum password age (days)
samba-tool domain passwordsettings set --max-pwd-age=90

# Set account lockout threshold
samba-tool domain passwordsettings set --account-lockout-threshold=5

# Set account lockout duration (minutes)
samba-tool domain passwordsettings set --account-lockout-duration=30
```

### Access Control Lists (ACLs)

```bash
# View ACL on object
samba-tool ntacl get /var/lib/samba/sysvol --as-sddl

# Set ACL on file share
samba-tool ntacl set 'O:BAG:DUD:PAI(A;OICI;FA;;;BA)' /share/folder

# Common SDDL examples:
# BA = Built-in Administrators
# DU = Domain Users
# FA = File All Access
# OICI = Object Inherit, Container Inherit
```

### Kerberos Ticket Management

```bash
# List current tickets
klist

# Get ticket for Administrator
kinit Administrator@AVCTN.LAN

# Destroy all tickets
kdestroy

# View ticket cache location
klist -c

# Set ticket to renewable
kinit -r 7d Administrator@AVCTN.LAN
```

## Performance Tuning

### Database Optimization

```bash
# Repack database (reduces size and improves performance)
samba-tool dbcheck --reindex

# Check and fix database issues
samba-tool dbcheck --fix --yes

# Show database statistics
samba-tool dbcheck --show-recycled
```

### File Share Performance

Add to `[global]` section in `smb.conf`:

```ini
# Increase async operations
aio read size = 16384
aio write size = 16384

# Enable sendfile (Linux kernel optimization)
use sendfile = yes

# Increase buffer sizes
socket options = TCP_NODELAY IPTOS_LOWDELAY SO_RCVBUF=524288 SO_SNDBUF=524288

# Enable kernel oplocks
kernel oplocks = yes

# Optimize read/write caching
strict allocate = yes
read raw = yes
write raw = yes
```

## Monitoring and Maintenance

### Health Checks

```bash
# Verify database integrity
samba-tool dbcheck --cross-ncs

# Test domain connectivity
samba-tool domain info 127.0.0.1

# Check SYSVOL replication
ls -la /var/lib/samba/sysvol/

# Verify DNS
host -t SRV _ldap._tcp.avctn.lan
host -t SRV _kerberos._tcp.avctn.lan

# Test LDAP connectivity
ldapsearch -H ldap://localhost -x -b "DC=avctn,DC=lan"

# Test SMB connectivity
smbclient -L localhost -N
```

### Log Analysis

```bash
# View authentication logs
tail -f /var/log/samba/log.smbd | grep -i auth

# View replication logs
+ tail -f /var/log/samba/log.samba | grep -i repl

# View DNS logs
tail -f /var/log/samba/log.samba | grep -i dns

# Search for errors
grep -i error /var/log/samba/*.log

# Search for warnings
grep -i warn /var/log/samba/*.log
```

### Regular Maintenance Tasks

**Daily:**

- Check replication status
- Review authentication logs for failures
- Monitor disk space on SYSVOL and logs

**Weekly:**

- Database integrity check (`samba-tool dbcheck`)
- Review and rotate logs
- Test backup restoration

**Monthly:**

- Update password expiry notifications
- Review inactive user accounts
- Test disaster recovery procedures
- Update documentation

## Backup and Recovery

### Online Backup

```bash
# Create online backup (domain still running)
samba-tool domain backup online \
    --server=ads1-98.avctn.lan \
    --targetdir=/backup/samba/online \
    -U Administrator

# Backup includes:
# - SYSVOL and GPOs
# - Directory database
# - DNS zones
# - Kerberos keys
```

### Offline Backup

```bash
# Create offline backup (must stop Samba first)
systemctl stop samba
samba-tool domain backup offline \
    --targetdir=/backup/samba/offline
systemctl start samba

# Smaller backup, faster restore
# Best for scheduled backups
```

### Restore Backup

```bash
# Restore to new DC
samba-tool domain backup restore \
    --backup-file=/backup/samba/backup.tar.bz2 \
    --newservername=ads-restore \
    --targetdir=/var/lib/samba

# Restore to same DC (emergency recovery)
systemctl stop samba
rm -rf /var/lib/samba/*
samba-tool domain backup restore \
    --backup-file=/backup/samba/backup.tar.bz2 \
    --targetdir=/var/lib/samba
systemctl start samba
```

## Advanced Configurations

### Trust Relationships (Future Phase)

```bash
# Create forest trust to external domain
samba-tool domain trust create external.lan \
    --type=external \
    -U Administrator

# List trusts
samba-tool domain trust list

# Validate trust
samba-tool domain trust validate external.lan -U Administrator
```

### Site Configuration (Multi-Site)

```bash
# Create new site
samba-tool sites create "Site-02"

# Move DC to different site
samba-tool sites move ads2-99 "Site-02"

# Create subnet for site
samba-tool subnet create 10.2.0.0/20 "Site-02"

# List sites
samba-tool sites list

# Show site topology
samba-tool sites view "Site-02"
```

### Schema Extensions (Advanced)

**Warning:** Schema changes are permanent and irreversible. Test thoroughly before production.

```bash
# Register schema extension
ldbadd -H /var/lib/samba/private/sam.ldb schema-extension.ldif

# Verify schema version
samba-tool schema objectclass show user
```

## Troubleshooting Common Issues

### Issue: DNS Not Resolving

```bash
# Check DNS service
netstat -tulpn | grep :53

# Verify DNS configuration
cat /etc/resolv.conf

# Test DNS resolution
host ads1-98.avctn.lan
host -t SRV _ldap._tcp.avctn.lan

# Fix: Restart Samba
systemctl restart samba
```

### Issue: Kerberos Authentication Failing

```bash
# Check time synchronization (must be < 5 min difference)
date
ntpdate -q pool.ntp.org

# Test Kerberos
kinit Administrator@AVCTN.LAN
klist

# Fix: Synchronize time
ntpdate -u pool.ntp.org
```

### Issue: Replication Not Working

```bash
# Check network connectivity between DCs
ping ads2-99.avctn.lan

# Verify Kerberos tickets
kinit Administrator@AVCTN.LAN

# Force replication
samba-tool drs replicate ads2-99 ads1-98 DC=avctn,DC=lan --full-sync

# Check replication errors
samba-tool drs showrepl | grep -i error
```

### Issue: Windows Client Can't Join Domain

**Common causes:**

1. DNS not configured correctly on client
2. Time synchronization off by > 5 minutes
3. Firewall blocking required ports
4. Wrong domain name or credentials

**Troubleshooting:**

```bash
# On Windows client, verify DNS:
nslookup avctn.lan
nslookup -type=SRV _ldap._tcp.avctn.lan

# Check time:
w32tm /query /status

# Test connectivity:
Test-NetConnection -ComputerName ads1-98.avctn.lan -Port 389
```

## References

- **Samba Wiki:** <https://wiki.samba.org/>
- **Samba Man Pages:** <https://www.samba.org/samba/docs/current/man-html/>
- **RFC 2307:** LDAP as a Network Information Service
- **MS-ADTS:** Active Directory Technical Specification
- **PRD:** See `docs/PRD.md`
- **PROJECT-HISTORY:** See `docs/PROJECT-HISTORY.md`
